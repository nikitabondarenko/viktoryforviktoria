<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-JSRC6JT2PK"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        // Check if Google Analytics is blocked
        window.addEventListener('error', function(e) {
            if (e.target.src && e.target.src.includes('googletagmanager.com')) {
                console.log('Google Analytics is blocked, using alternative tracking');
            }
        }, true);

        // Get location data with fallback
        fetch('https://ipapi.co/json/')
            .then(response => response.json())
            .then(data => {
                try {
                    gtag('set', {
                        'country': data.country_name,
                        'city': data.city,
                        'region': data.region,
                        'latitude': data.latitude,
                        'longitude': data.longitude,
                        'timezone': data.timezone,
                        'location_source': 'ip'
                    });
                } catch (error) {
                    localStorage.setItem('visitor_location', JSON.stringify({
                        ...data,
                        location_source: 'ip'
                    }));
                }
            })
            .catch(error => {
                console.log('Error fetching IP location:', error);
                // Try browser geolocation as fallback
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        function(position) {
                            const locationData = {
                                latitude: position.coords.latitude,
                                longitude: position.coords.longitude,
                                accuracy: position.coords.accuracy,
                                location_source: 'browser'
                            };
                            try {
                                gtag('set', locationData);
                            } catch (error) {
                                localStorage.setItem('visitor_location', JSON.stringify(locationData));
                            }
                        },
                        function(error) {
                            console.log('Geolocation permission denied or error:', error);
                            // Store that we tried but couldn't get location
                            localStorage.setItem('visitor_location', JSON.stringify({
                                location_source: 'none',
                                error: error.message
                            }));
                        }
                    );
                } else {
                    // Browser doesn't support geolocation
                    localStorage.setItem('visitor_location', JSON.stringify({
                        location_source: 'none',
                        error: 'Geolocation not supported'
                    }));
                }
            });

        gtag('config', 'G-JSRC6JT2PK', {
            'anonymize_ip': true,
            'allow_google_signals': true,
            'allow_ad_personalization_signals': true,
            'send_page_view': true,
            'debug_mode': false,
            'demographics': true,
            'interests': true,
            'page_location': window.location.href,
            'page_title': document.title,
            'screen_resolution': window.screen.width + 'x' + window.screen.height,
            'viewport_size': window.innerWidth + 'x' + window.innerHeight,
            'user_language': navigator.language,
            'user_agent': navigator.userAgent,
            'client_storage': 'localStorage' in window ? 'enabled' : 'disabled',
            'session_start': new Date().toISOString(),
            'custom_map': {
                'dimension1': 'user_type',
                'dimension2': 'engagement_level',
                'dimension3': 'content_category'
            }
        });

        // Track user engagement level
        let engagementStartTime = new Date().getTime();
        let scrollDepth = 0;
        let maxScrollDepth = 0;

        window.addEventListener('scroll', function() {
            let scrollPercent = Math.round((window.scrollY + window.innerHeight) / document.documentElement.scrollHeight * 100);
            maxScrollDepth = Math.max(maxScrollDepth, scrollPercent);
            
            // Track scroll depth at 25%, 50%, 75%, and 100%
            if (scrollPercent >= 25 && scrollDepth < 25) {
                gtag('event', 'scroll_depth', {
                    'event_category': 'engagement',
                    'event_label': '25%',
                    'value': 25
                });
                scrollDepth = 25;
            } else if (scrollPercent >= 50 && scrollDepth < 50) {
                gtag('event', 'scroll_depth', {
                    'event_category': 'engagement',
                    'event_label': '50%',
                    'value': 50
                });
                scrollDepth = 50;
            } else if (scrollPercent >= 75 && scrollDepth < 75) {
                gtag('event', 'scroll_depth', {
                    'event_category': 'engagement',
                    'event_label': '75%',
                    'value': 75
                });
                scrollDepth = 75;
            } else if (scrollPercent >= 100 && scrollDepth < 100) {
                gtag('event', 'scroll_depth', {
                    'event_category': 'engagement',
                    'event_label': '100%',
                    'value': 100
                });
                scrollDepth = 100;
            }
        });

        // Track user type based on behavior
        let userType = 'new';
        if (localStorage.getItem('returning_user')) {
            userType = 'returning';
        } else {
            localStorage.setItem('returning_user', 'true');
        }
        gtag('set', 'user_type', userType);
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stand with Viktoria</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header>
        <h1>Stand with Viktoria</h1>
        <nav>
            <ul>
                <li><a href="index.html" onclick="gtag('event', 'navigation', {'event_category': 'menu', 'event_label': 'home'});">Home</a></li>
                <li><a href="full_story.html" onclick="gtag('event', 'navigation', {'event_category': 'menu', 'event_label': 'full_story'});">What Happened?</a></li>
                <li><a href="support.html" onclick="gtag('event', 'navigation', {'event_category': 'menu', 'event_label': 'support'});">Community Letters</a></li>
                <li><a href="donate.html" onclick="gtag('event', 'navigation', {'event_category': 'menu', 'event_label': 'donate'});">Donate</a></li>
            </ul>
        </nav>
    </header>
    
    <main>
        <section class="hero">
            <h2>Help Viktoria Rebuild After Injustice</h2>
            <img src="vika_teaching.jpg" alt="Viktoria teaching ballet">
            <p><strong>Viktoria Titova</strong> dedicated 17 years of her life to building two ballet companiesâ€”Emerald Ballet Theatre and Emerald Ballet Academy. After all her hard work, she was wrongfully removed by her own Board.</p>
            <a href="donate.html" class="btn" onclick="gtag('event', 'click', {'event_category': 'cta', 'event_label': 'donate_now_home'});">Donate Now</a>
            <a href="https://www.facebook.com/profile.php?id=61574439930191" class="btn" onclick="gtag('event', 'click', {'event_category': 'social', 'event_label': 'facebook_join'});">Join the Conversation</a>
        </section>
    </main>

    <footer>
        <p>&copy; 2025 Stand with Viktoria</p>
    </footer>

    <script>
        // Track page load time
        window.addEventListener('load', function() {
            setTimeout(function() {
                gtag('event', 'timing_complete', {
                    'name': 'load',
                    'value': performance.now(),
                    'event_category': 'Performance'
                });
            }, 0);
        });

        // Track time spent on page
        let startTime = new Date().getTime();
        window.addEventListener('beforeunload', function() {
            let endTime = new Date().getTime();
            let timeSpent = (endTime - startTime) / 1000; // Convert to seconds
            gtag('event', 'time_spent', {
                'event_category': 'engagement',
                'event_label': 'home_page',
                'value': Math.round(timeSpent)
            });
        });
    </script>
</body>
</html>